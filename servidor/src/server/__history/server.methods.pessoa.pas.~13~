unit server.methods.pessoa;

interface

uses
  System.SysUtils,
  System.Classes,
  Datasnap.DSServer,
  Datasnap.DSAuth,
  System.TypInfo,
  System.Generics.Collections,
  REST.JSON,
  System.JSON;

type
{$METHODINFO ON}
  TServerMethods1 = class(TComponent)
  private
    { Private declarations }
  public
    { Public declarations }
    function EchoString(Value: string): string;
    function ReverseString(Value: string): string;
    function Pessoas: TJSONArray;
    function uptatePessoas(Value: TJSONObject): TJSONObject;
    function acceptPessoas(Value: TJSONObject): TJSONObject;
    function deletePessoas(Value: Integer): Boolean;
  end;

{$METHODINFO OFF}

implementation

uses
  System.StrUtils,
  model.enums,
  model.utils,
  model.entity.pessoa,
  server.conexao;

function TServerMethods1.acceptPessoas(Value: TJSONObject): TJSONObject;
var
  vPessoa: TPessoa;
  vPessoaResult: TPessoa;
begin
  dmConexao := TdmConexao.Create(nil);
  try
    vPessoa := TUtils.JSONToObject<TPessoa>(Value.ToString);
    vPessoaResult := dmConexao.InsertPessoa(vPessoa);
    Result := TUtils.ObjectToJSON<TPessoa>(vPessoaResult);
  finally
    vPessoa.Free;
    vPessoaResult.Free;
    dmConexao.Free;
  end;

end;

function TServerMethods1.deletePessoas(Value: Integer): Boolean;
begin
  dmConexao := TdmConexao.Create(nil);
  try
    Result := dmConexao.DeletePessoa(Value);
  finally
    dmConexao.Free;
  end;
end;

function TServerMethods1.EchoString(Value: string): string;
begin
  Result := Value;
end;

function TServerMethods1.Pessoas: TJSONArray;
var
  vListaPessoas: TObjectList<TPessoa>;
begin
  dmConexao := TdmConexao.Create(nil);
  try
    vListaPessoas := dmConexao.GetPessoas;
    Result := TUtils.ObjectListToJSON<TPessoa>(vListaPessoas);
  finally
    dmConexao.Free;
    vListaPessoas.Free;
  end;
end;

function TServerMethods1.ReverseString(Value: string): string;
begin
  Result := System.StrUtils.ReverseString(Value);
end;

function TServerMethods1.uptatePessoas(Value: TJSONObject): TJSONObject;
var
  vPessoa: TPessoa;
  vPessoaResult: TPessoa;
begin
  dmConexao := TdmConexao.Create(nil);
  try
    vPessoa := TUtils.JSONToObject<TPessoa>(Value.ToString);
    vPessoaResult := dmConexao.UpdatePessoa(vPessoa);
    Result := TUtils.ObjectToJSON<TPessoa>(vPessoaResult);
  finally
    vPessoa.Free;
    vPessoaResult.Free;
    dmConexao.Free;
  end;
end;

end.
